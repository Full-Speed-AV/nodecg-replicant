<link rel="import" href="../polymer/polymer.html">

<script>
    'use strict';

    /**
     * `Polymer.NodeCGReplicantTargetingBehavior` adds the `replicantName` and `replicantBundle` properties
     * to your element. `replicantBundle` is optional and defaults to the current bundle. Once both properties are
     * defined, the target replicant will become available as the `replicant` property.
     *
     * To listen to `change` events emitted by this replicant, add a method called `_replicantChanged` to your bundle.
     *
     *     _replicantChanged: function(oldVal, newVal, changes) {
     *          // do work...
     *     }
     *
     * The target replicant can be freely changed at any time.
     * @polymerBehavior
     */
    Polymer.NodeCGReplicantTargetingBehavior = {

        /**
         * Fired when a new replicant is targeted.
         *
         * @event retarget
         */

        properties: {
            /**
             * The name of the target replicant.
             */
            replicantName: {
                type: String
            },

            /**
             * The bundle namespace of the target replicant. If a NodeCG API context is available (`window.nodecg`),
             * this defaults to the current bundle (`window.nodecg.bundleName`).
             */
            replicantBundle: {
                type: String,
                value: function() {
                    if (typeof window.nodecg === 'object') {
                        return window.nodecg.bundleName
                    }
                }
            }
        },

        get _hasChangeCallback () {
            return typeof this._replicantChanged === 'function';
        },

        observers: [
            '_targetChanged(replicantName, replicantBundle)'
        ],

        _targetChanged: function(name, bundle) {
            // If there is an existing replicant, remove the event listener
            if (this.replicant && this._hasChangeCallback) {
                this.replicant.removeListener('change', this._replicantChanged);
            }

            this._declareReplicant(name, bundle);
        },

        _declareReplicant: function(name, bundle) {
            if (this._waitingForDOMReady) return;

            if (document.readyState !== 'complete' && !this._DOMContentLoaded) {
                this._waitingForDOMReady = true;
                document.addEventListener('DOMContentLoaded', function() {
                    this._waitingForDOMReady = false;
                    this._DOMContentLoaded = true;
                    this._declareReplicant(name, bundle);
                }.bind(this), false);
                return;
            }

            if (this.defaultValue) {
                this.replicant = NodeCG.Replicant(name, bundle, {defaultValue: this.defaultValue});
            } else {
                this.replicant = NodeCG.Replicant(name, bundle);
            }

            if (this._hasChangeCallback) {
                this.replicant.on('change', this._replicantChanged.bind(this));
            }

            this.fire('retarget', {name: name, bundle: bundle}, {bubbles: false})
        }

    };

</script>